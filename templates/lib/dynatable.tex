<?lsmb#   This is a comment block; it's ignored by the template engine.

   Version:  1.2
   Date:     2023-12-01
   File:     dynatable.tex
   Set:      none; shared

Template version numbers are explicitly not aligned across templates or
releases. No explicit versioning was applied before 2021-01-04.

Version   Changes
1.2       Encode data from the 'columns' input, because the caller stopped its
          encoding to fix GitHub issue #7739.
1.1       Simplified version which also works without columns of pre-declared
          width by using tabular environments to capture 'intentionally multi-
          line output' into a single cell.


-?>
<?lsmb- BLOCK dynatable;

TOTAL_WIDTH=14; # cm. using A4 as a basis because it is slightly narrower than
                # US Letter. This way the dynatable works for both paper sizes.
                # This assumes a 1cm margin on either side. --CT
DECLARED_WIDTH=0;

SKIP_TYPES = ['hidden', 'radio', 'checkbox'];


FOREACH COL IN columns;
    DECLARED_WIDTH = DECLARED_WIDTH + COL.pwidth; # pwidth is arbitrary scale
END;

IF DECLARED_WIDTH > 0;
    WIDTH_PER_P = TOTAL_WIDTH / DECLARED_WIDTH;
ELSE;
    WIDTH_PER_P = 1;
END;
 ?>
\begin{longtable}{<?lsmb-

FOREACH COL IN columns;
   IF COL.psep_before;
      '|';
   END;
   IF 1 == SKIP_TYPES.grep(COL.type).size() or COL.html_only;
      '';
   ELSIF COL.pwidth;
       "p{" _ (COL.pwidth * WIDTH_PER_P) _ "cm}";
   ELSIF COL.palign;
        COL.palign;
   ELSE;
        'l';
   END;
   IF COL.psep_after;
      '|';
   END;
END;
-?>}
<?lsmb
FOREACH COL IN columns;
    IF 0 == SKIP_TYPES.grep(COL.type).size() AND ! COL.html_only;
        UNLESS loop.first();
           ' & ';
        END;
        COL.name;
    END;
END;
-?>\tabularnewline
\hline\hline
\endfirsthead
<?lsmb

FOREACH COL IN columns;
    IF 0 == SKIP_TYPES.grep(COL.type).size() AND ! COL.html_only;
        UNLESS loop.first() ;
           ' & ';
        END;
        escape(COL.name);
    END;
END;
-?>\tabularnewline
\hline\hline
\endhead
<?lsmb

FOREACH ROW IN tbody.rows;
    FOREACH COL IN columns;
        IF 0 == SKIP_TYPES.grep(COL.type).size() AND ! COL.html_only;
            UNLESS loop.first();
               ' & ';
            END;
            ?>\begin{tabular}[t]{@{}l@{}}<?lsmb
                ROW.${COL.col_id};
            ?>\end{tabular}<?lsmb
        END;
    END;
    ?>\tabularnewline
<?lsmb
END; # FOREACH ?>
\end{longtable}
<?lsmb END;  # block dynatable -?>
